{"name":"Vízfogyasztás","type":"virtual_device","properties":{"deviceIcon":1001,"currentIcon":"1001","log":"","logTemp":"","mainLoop":"-- set up some local variables\nlocal thisId = fibaro:getSelfId();\nlocal currenttime = (os.date(\"%H:%M\"))\n\nfunction f_Debug(color, message)\n  fibaro:debug(string.format('<%s style=\"color:%s;\">%s</%s>', \"span\", color, message, \"span\")); \nend\n\nlocal WATER_GLOBAL_NAME = \"vg_WaterJson\"\nlocal PRICE_PER_CUBIC_METER = 252.60\nlocal PRICE_PER_MONTH = 179.95\n\nfunction f_ReadGlobalJson(isDebug,varName)\n  local debugMessage\n  local dataEncoded=fibaro:getGlobalValue(varName)\n  if dataEncoded and dataEncoded ~= \"null\" then\n    debugMessage = \"f_ReadGlobalJson:\" .. varName .. \" returns \".. dataEncoded\n    if isDebug then f_Debug(\"grey\",debugMessage) end\n  else\n    debugMessage = \"f_ReadGlobalJson:\" .. varName ..\" returns nil or null. Please check \" ..\n    \"if Global Variable exists. Program continues and will not crash\"\n    f_Debug(\"red\",debugMessage)  \n    return false, nil\n  end\n  -- This is where the magic happens:\n  local ok, data = pcall(json.decode, dataEncoded)\n  if ok then\n    if isDebug then f_Debug(\"grey\",\"f_ReadGlobalJson: decode OK\") end\n  else\n    f_Debug(\"red\",\"f_ReadGlobalJson: decode failed with error:\" .. data)\n  end\n  return ok, data\nend\n\nfunction f_getDisplayedStats(isDebug)\n\tif isDebug then f_Debug(\"white\",\"f_getDisplayedStats: entering function\") end\n\tlocal ok, waterConsumptionTable\n  \t-- Reading waterConsumptionTable\n    ok, waterConsumptionTable = f_ReadGlobalJson(isDebug,WATER_GLOBAL_NAME)\n\tif isDebug then f_Debug(\"white\",\"f_getDisplayedStats: absolute \" .. waterConsumptionTable.absoluteConsumption) end\n\tfibaro:call(thisId, \"setProperty\",\"ui.absolute.value\", \"Teljes vízfogyasztás: \".. waterConsumptionTable.absoluteConsumption ..\" liter\")\n\tfibaro:call(thisId, \"setProperty\",\"ui.details.value\", \n\t\t\" Óra: \"..waterConsumptionTable.absoluteConsumption - waterConsumptionTable.consumptionAtLastHour ..\" liter \" ..\n\t\t\"\\n Napi: \"..waterConsumptionTable.absoluteConsumption - waterConsumptionTable.consumptionAtLastMidnight ..\" liter \" .. \n\t\t\"\\n Havi: \"..waterConsumptionTable.absoluteConsumption - waterConsumptionTable.consumptionAtLastMonthChange ..\" liter \")\n\tfibaro:call(thisId, \"setProperty\",\"ui.price.value\", \"Havi alapdíj: \"..PRICE_PER_MONTH ..\" Ft Vízdíj: \" .. PRICE_PER_CUBIC_METER .. \" Ft/m3\")\n\tfibaro:call(thisId, \"setProperty\",\"ui.bill.value\", \"Havi vízszámla: \"..\n\t\t(waterConsumptionTable.absoluteConsumption - waterConsumptionTable.consumptionAtLastMonthChange)*PRICE_PER_CUBIC_METER/1000 +  PRICE_PER_MONTH ..\" Ft\")\t\nend\n\nf_getDisplayedStats(true)","ui.absolute.value":"Teljes vízfogyasztás: 33 liter","ui.bill.value":"Havi vízszámla: 188.2858 Ft","ui.details.value":" Óra: 0.5 liter \n Napi: 33 liter \n Havi: 33 liter ","ui.price.value":"Havi alapdíj: 179.95 Ft Vízdíj: 252.6 Ft/m3","visible":"true","rows":[{"type":"label","elements":[{"id":1,"lua":false,"waitForResponse":false,"caption":"","name":"absolute","favourite":false,"main":true}]},{"type":"label","elements":[{"id":2,"lua":false,"waitForResponse":false,"caption":"","name":"details","favourite":false,"main":false}]},{"type":"label","elements":[{"id":3,"lua":false,"waitForResponse":false,"caption":"","name":"price","favourite":false,"main":false}]},{"type":"label","elements":[{"id":4,"lua":false,"waitForResponse":false,"caption":"","name":"bill","favourite":false,"main":false}]}]},"actions":{"pressButton":1,"setSlider":2,"setProperty":2}}